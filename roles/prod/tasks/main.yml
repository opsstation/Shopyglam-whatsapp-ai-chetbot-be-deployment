- name: Ensure required packages installed
  apt:
    name:
      - docker.io
      - git
    state: present
    update_cache: yes

- name: Ensure Docker service running
  service:
    name: docker
    state: started
    enabled: yes

 ğŸ” Clone repo (replaces rm -rf + git clone)
- name: Clone WhatsApp chatbot repository
  ansible.builtin.git:
    repo: "{{ repo_ssh_url }}"
    dest: "{{ repo_dir }}"
    version: "{{ repo_branch }}"
    force: yes
    accept_hostkey: yes

# ğŸ³ Build image (equivalent to --no-cache)
- name: Build Docker image
  community.docker.docker_image:
    name: "{{ image_name }}"
    tag: "{{ image_tag }}"
    build:
      path: "{{ repo_dir }}"
      nocache: yes
    source: build

# ğŸ›‘ Remove old containers if exist
- name: Remove old FastAPI container
  community.docker.docker_container:
    name: "{{ fastapi_container }}"
    state: absent
    force_kill: yes

- name: Remove old Socket container
  community.docker.docker_container:
    name: "{{ socket_container }}"
    state: absent
    force_kill: yes

- name: Remove old Celery container
  community.docker.docker_container:
    name: "{{ celery_container }}"
    state: absent
    force_kill: yes

# ğŸš€ FastAPI
- name: Run FastAPI container
  community.docker.docker_container:
    name: "{{ fastapi_container }}"
    image: "{{ image_name }}:{{ image_tag }}"
    restart_policy: unless-stopped
    env_file: "{{ repo_dir }}/{{ prod_env_file }}"
    published_ports:
      - "127.0.0.1:8000:8000"
    state: started

# ğŸš€ Socket.IO
- name: Run Socket.IO container
  community.docker.docker_container:
    name: "{{ socket_container }}"
    image: "{{ image_name }}:{{ image_tag }}"
    command: uvicorn app.socket_app:socket_app --host 0.0.0.0 --port 9000
    restart_policy: unless-stopped
    env_file: "{{ repo_dir }}/{{ prod_env_file }}"
    published_ports:
      - "127.0.0.1:9000:9000"
    state: started

# ğŸš€ Celery
- name: Run Celery worker container
  community.docker.docker_container:
    name: "{{ celery_container }}"
    image: "{{ image_name }}:{{ image_tag }}"
    command: celery -A app.core.celery_app worker --loglevel=info
    restart_policy: unless-stopped
    env_file: "{{ repo_dir }}/{{ prod_env_file }}"
    state: started